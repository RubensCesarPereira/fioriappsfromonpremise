sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/library","cl/conchaytoro/zmm_traslado_vino/model/formatter"],function(e,t,i,s){"use strict";return e.extend("cl.conchaytoro.zmm_traslado_vino.controller.Detail",{formatter:s,onInit:function(){var e=this.byId("lineItemsList");this._oList=e;var i=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(i,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this.initView()},initView:function(){this.setToDay();this.setDayConta();this.setPositionListItem(0)},onRefresh:function(){this._oList.getBinding("items").refresh()},navButtonPress:function(e){},setToDay:function(){var e=this.getView().byId("erdat");var t=new Date;e.setDateValue(t);e.setMinDate(t);e.setMaxDate(t)},setDayConta:function(){var e=new Date;var t=this.getView().byId("fechaConta");t.setDateValue(e);var i=new Date;i=i.setDate(i.getDate()-5);i=new Date(i);t.setMinDate(i);t.setMaxDate(e)},setPositionListItem:function(e){if(e!==undefined&&e!==""){var t=parseInt(e,10);var i=this.byId("lineItemsList").getItems();if(i.length>0){i[t].firePress()}}},clearValues:function(e){var t=this.byId("lineItemsList");var i=t.getItems();i.forEach(function(e){e.getCells()[8].setSelected(false)});if(e!=="undefined"&&e==="full"){var s=this.byId("objectHeader");var n=this.byId("erdat");var a=this.byId("werks");n.setValue("");a.setValue("");s.setNumber("");s.setNumberUnit("")}},onShareEmailPress:function(){var e=this.getModel("detailView");sap.m.URLHelper.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onListUpdateFinished:function(e){var t,i=e.getParameter("total"),s=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(i){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[i])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}s.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;if(!t){return}this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("EntregaSet",{Vbeln:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var i=t.getPath(),s=this.getResourceBundle(),n=e.getModel().getObject(i),a=n.Vbeln,r=n.Vbeln,o=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(i);o.setProperty("/shareSendEmailSubject",s.getText("shareSendEmailObjectSubject",[a]));o.setProperty("/shareSendEmailMessage",s.getText("shareSendEmailObjectMessage",[r,a,location.href]));this.clearValues()},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),i=this.byId("lineItemsList"),s=i.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);i.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",s)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onContabilizarPress:function(e){var t=this.getOwnerComponent().getModel();if(t==="undefined")return;var i=sap.ui.getCore().byId("application-ZOBJ_SEM_TRAS_VINO-display-component---master--list");var s=this.byId("lineItemsList");var n=s.getItems();var a=[];var r=this;var o=this.getView().byId("objectHeader").getNumber();var l=this.getView().byId("objectHeader").getNumberUnit();var d=this.getView().byId("fechaConta").getValue();n.forEach(function(e){if(e.getCells()[9].getSelected()){a.push({Vbeln:o,Posnr:e.getCells()[0].getText(),Matnr:e.getCells()[1].getText(),Lfimg:e.getCells()[3].getText(),Meins:e.getCells()[4].getUnit(),Werks:e.getCells()[5].getText(),Lgort:e.getCells()[6].getText(),Charg:e.getCells()[7].getText(),Gjahr:e.getCells()[8].getText(),Updkz:"U"})}});if(n.length>0){var c={Vbeln:o,Erdat:l,Fecha:d,EntregaToPosiciones:a};sap.ui.core.BusyIndicator.show();t.create("/EntregaSet",c,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Vbeln!==""){sap.m.MessageBox.success("La Entrega N° "+e.Vbeln+" ha sido Contabilizada!",{title:"Confirmación",onClose:function(){s.getBinding("items").refresh(true);var e=s.getItems().length;if(e===1){i.getBinding("items").refresh(true);var t=i.getItems().length;if(t>=1){i.getItems()[0].firePress()}r.clearValues("full")}else{r.clearValues()}},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{if(e.Message!==""){sap.m.MessageBox.warning(e.Message,{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.warning("¡Error al Contabilizar!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Ocurrio un error en la contabilización!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})}},onCancelarPress:function(e){this.clearValues()},onNavBack:function(){this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")}})});