/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");jQuery.sap.require("sap.ca.ui.quickoverview.CompanyLaunch");jQuery.sap.require("ui.s2p.mm.requisition.approve.util.Conversions");sap.ca.scfld.md.controller.BaseDetailController.extend("ui.s2p.mm.requisition.approve.view.ItemDetails",{sOrigin:"",sWorkitemID:"",sPrNumber:"",sItemNumber:"",onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);if(!this.oApplication){this.oApplication=sap.ca.scfld.md.app.Application.getImpl();this.oConfiguration=this.oApplication.oConfiguration;this.oConnectionManager=this.oApplication.getConnectionManager();this.resourceBundle=this.oApplication.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();}this.getView().getModel().setSizeLimit(1000000);this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="itemDetails"){this.sOrigin=e.getParameter("arguments").SAP__Origin;this.sWorkitemID=e.getParameter("arguments").WorkitemID;this.sPrNumber=e.getParameter("arguments").PrNumber;this.sItemNumber=e.getParameter("arguments").ItemNumber;var i="/WorkflowTaskCollection(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"')"+"/HeaderDetails/HeaderItemDetails(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"',PrNumber='"+this.sPrNumber+"',ItemNumber='"+this.sItemNumber+"')";var I="/HeaderItemDetailCollection(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"',PrNumber='"+this.sPrNumber+"',ItemNumber='"+this.sItemNumber+"')";var o=this.oDataModel.getProperty(I);if(typeof o==="undefined"){this.navBack();return;}var s="";if(o){s=o.ItemCategory;}var S=this.byId("SubcontractingTable");if(s==="3"){this.getView().bindElement(i,{expand:"Accountings,Notes,Attachments,ServiceLines/Accountings,Limits/Accountings,Components"});this.getView().getElementBinding().attachEventOnce("dataReceived",function(){var c=[new sap.m.ObjectIdentifier({title:"{parts:[{path : 'Description'}, {path : 'Material'}], formatter : 'ui.s2p.mm.requisition.approve.util.Conversions.commonIDFormatter'}"}),new sap.m.ObjectNumber({number:"{parts: [{path : 'Quantity'}], formatter : 'ui.s2p.mm.requisition.approve.util.Conversions.quantityFormatterWithoutUnit'}",numberUnit:"{BaseUnitDescription}"})];var t=new sap.m.ColumnListItem({cells:c});S.bindItems("Components",t,null,null);S.setVisible(true);},this);}else{S.unbindItems();S.setVisible(false);this.getView().bindElement(i,{expand:"Accountings,Notes,Attachments,ServiceLines/Accountings,Limits/Accountings"});}this.setLocalHeaderFooterOptions();}},this);if(this.extHookOnInit){this.extHookOnInit();}},setLocalHeaderFooterOptions:function(){var t=this;var h=this._headerDetailCollection(this.sOrigin,this.sWorkitemID);var i=this._itemDetailCollection(this.sOrigin,this.sWorkitemID,this.sPrNumber,this.sItemNumber);var I=this.oDataModel.getProperty("/"+h+'/HeaderItemDetails');if(typeof I==="undefined"){this.navBack();return;}var l=I.length;var c=I.indexOf(i);var L={onBack:function(){t.navBack();},oUpDownOptions:{iPosition:c,iCount:l,fSetPosition:function(n){var p=I[n];var s=t.oDataModel.getProperty("/"+p).ItemNumber;t.oRouter.navTo("itemDetails",{SAP__Origin:t.sOrigin,WorkitemID:t.sWorkitemID,PrNumber:t.sPrNumber,ItemNumber:s},true);},sI18NDetailTitle:"view.ItemDetails.title"}};if(this.extHookSetHeaderFooterOptions){L=this.extHookSetHeaderFooterOptions(L);}this.setHeaderFooterOptions(L);},navBack:function(){if(this.sOrigin!==""&&this.sWorkitemID!==""){var m="WorkflowTaskCollection(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"')";this.oRouter.navTo("headerDetail",{contextPath:m},true);}},_refresh:function(c,e,d){},onServiceItemPress:function(e){var b=e.getSource().getBindingContext().getPath();var m=this.getView().getModel();this.oRouter.navTo("itemServiceLine",{SAP__Origin:this.getView().getBindingContext().getProperty("SAP__Origin"),WorkitemID:this.sWorkitemID,PrNumber:this.getView().getBindingContext().getProperty("PrNumber"),ItemNumber:this.getView().getBindingContext().getProperty("ItemNumber"),ServiceLineNumber:m.getProperty(b).ServiceLineNumber},true);},onServiceLimitPress:function(e){var b=e.getSource().getBindingContext().getPath();var m=this.getView().getModel();var d=m.getProperty(b).LimitDescription;d=encodeURIComponent(d.trim());this.oRouter.navTo("itemServiceLimit",{SAP__Origin:this.getView().getBindingContext().getProperty("SAP__Origin"),WorkitemID:this.sWorkitemID,PrNumber:this.getView().getBindingContext().getProperty("PrNumber"),ItemNumber:this.getView().getBindingContext().getProperty("ItemNumber"),LimitDescription:d},true);},_headerDetailCollection:function(o,w){var r="HeaderDetailCollection(SAP__Origin='"+o+"',WorkitemID='"+w+"')";return r;},_itemDetailCollection:function(o,w,p,i){var r="HeaderItemDetailCollection(SAP__Origin='"+o+"',WorkitemID='"+w+"',PrNumber='"+p+"',ItemNumber='"+i+"')";return r;},onAttachment:function(e){ui.s2p.mm.requisition.approve.util.Conversions.onAttachment(e);},onSenderPress:function(e){this.openEmployeeLaunch(e,"CreatedByID");},openEmployeeLaunch:function(e,r){var c=e.getSource();var t=this.resourceBundle.getText("BussinessCard.Employee");var o=function(d){var a=d.results[0],E={title:t,name:a.FullName,department:a.Department,contactmobile:a.MobilePhone,contactphone:a.WorkPhone,contactemail:a.EMail,companyname:a.CompanyName,companyaddress:a.AddressString},b=new sap.ca.ui.quickoverview.EmployeeLaunch(E);b.openBy(c);};var O=e.getSource().getBindingContext().getProperty("SAP__Origin");var u=e.getSource().getBindingContext().getProperty(r);var f="$filter="+encodeURIComponent("UserID eq '"+u+"' and SAP__Origin eq '"+O+"'");this.oDataModel.read("UserDetailsCollection",null,[f],true,jQuery.proxy(o,this),jQuery.proxy(this._onRequestFailed,this));},onSupplierPress:function(e){this.onCompanyLaunch(e,"SupplierID");},onCompanyLaunch:function(e,r){var t=this.oApplicationFacade.getResourceBundle().getText("BusinessCard.supplier");var s=this.oApplicationFacade.getODataModel().getProperty("SupplierID",this.getView().getBindingContext());var c=e.getSource();var o=this.getView().getBindingContext().getProperty("SAP__Origin");var a=this.oApplicationFacade;var S="SupplierDetailCollection(SupplierID='"+s+"',SAP__Origin='"+o+"')";var p=["$expand=SupplierContacts"];sap.ca.ui.utils.busydialog.requireBusyDialog();a.getODataModel().read(S,null,p,true,function(d,b){sap.ca.ui.utils.busydialog.releaseBusyDialog();var h=(d.SupplierContacts&&(d.SupplierContacts.length>0));var f={title:t,imgurl:ui.s2p.mm.requisition.approve.util.Conversions.businessCardImg(d.Mime_Type,d.__metadata.media_src),companyname:d.SupplierName,companyphone:d.WorkPhone,companyaddress:d.AddressString,maincontactname:h?d.SupplierContacts[0].ContactName:d.ContactName,maincontactmobile:h?d.SupplierContacts[0].MobilePhone:d.MobilePhone,maincontactphone:h?d.SupplierContacts[0].WorkPhone:d.WorkPhone,maincontactemail:h?d.SupplierContacts[0].oData.EMail:d.EMail};var g=new sap.ca.ui.quickoverview.CompanyLaunch(f);g.openBy(c);},function(E){sap.ca.ui.utils.busydialog.releaseBusyDialog();});},_onRequestFailed:function(e){var m="";var d=null;if(e.response&&e.response.body!=""&&(e.response.statusCode=="400"||e.response.statusCode=="500")){var M=JSON.parse(e.response.body);m=M.error.message.value;}if(m==""){m=e.message;d=e.response.body;}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m,details:d});}});
