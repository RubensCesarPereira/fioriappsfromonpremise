sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","cl/conchaytoro/zpp_descomponer_mezcla/model/formatter"],function(e,t,a,r,i,o){"use strict";var s;return e.extend("cl.conchaytoro.zpp_descomponer_mezcla.controller.View1",{formatter:o,_cantidadMax:0,onInit:function(){$.sap.Adicion=["11016449","11016626","11003526","11013396","488000","488010","488510","497010","497310","489510"];var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("Materiales").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=e.getParameter("arguments").Orden;var r=this.getView().byId("orden");r.setText(t);var i=e.getParameter("arguments").Cantidad;var o=this.getView().byId("cantidad");o.setValue(i);this._cantidadMax=i;this.calculado=false;var s=this.getView().byId("tablaMateriales");var n=this.getOwnerComponent().getModel("dos");var l=[];var c=new sap.ui.model.Filter("Orden",sap.ui.model.FilterOperator.EQ,t);l.push(c);sap.ui.core.BusyIndicator.show();var u=this;n.read("/DesclistaSet",{filters:l,success:function(e){sap.ui.core.BusyIndicator.hide();s.setModel(new a(e.results),"materiales");s.getItems().forEach(function(e,t){e.getCells()[3].getCustomData()[0].setValue(e.getModel("materiales").getData()[t].Cantidad);if(s.getModel("materiales").oData[t].MTART!=""){e.setVisible(false)}});u.calculaComponente()},error:function(e){sap.ui.core.BusyIndicator.hide();s.setModel(new a([]),"materiales");sap.m.MessageBox.error("Error en El Servicio",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},_onPageNavButtonPress:function(){var e=t.getInstance();var a=e.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{var r=sap.ui.core.UIComponent.getRouterFor(this);r.navTo("RouteView1",{},true)}},calculaComponente:function(){this.calculado=true;var e=this.getView().byId("tablaMateriales");var t=Number(this.getView().byId("cantidad").getValue().split(".").join("").replace(",","."));var a=this._cantidadMax;var r=this.getView().byId("cantidad").getValue();var i=Number(this._cantidadMax.split(".").join("").replace(",","."));var o=0;var n=0;var l=0;if(t>i){sap.m.MessageBox.error("Stock ingresado supera el máximo disponible de "+this._cantidadMax,{title:"Error",onClose:function(){return},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});this.calculado=false;return false}e.getItems().forEach(function(e,t){o=o+Number(e.getCells()[3].data("IniCant").trim().split(".").join("").replace(",","."))});s=e;e.getItems().forEach(function(e,a){if(s.getModel("materiales").oData[a].MTART==""){n=Number(e.getCells()[3].data("IniCant").trim().split(".").join("").replace(",","."));l=t*n/o;e.getCells()[3].setText(Intl.NumberFormat("de-DE").format(l.toFixed(3)))}});return true},addDot:function(e){this.calculado=false;if(!/^[\d]+(\.[\d]{3,})*(\,[\d]{1,3})?$/.test(e.getParameter("value"))){e.getSource().setValue(e.getParameter("value"));e.getSource().setValueState(sap.ui.core.ValueState.Error);return}e.getSource().setValueState(sap.ui.core.ValueState.Success);var t=e.getParameter("value");var a=t.split(".").join("");a=a.split(",");var r=a[0].split("").reverse();var i=[];var o="";var s=Math.ceil(r.length/3);for(var n=0;n<s;n++){for(var l=0;l<3;l++){if(r[l+n*3]!==undefined){o+=r[l+n*3]}}i.push(o);o="";if(a[1]!==undefined)e.getSource().setValue(i.join(".").split("").reverse().join("")+","+a[1]);else e.getSource().setValue(i.join(".").split("").reverse().join(""))}},onSave:function(){var e=this;var t=this.getOwnerComponent().getModel("dos");var a=this.getView().byId("orden").getText();if(!this.calculaComponente()){return}if(!this.calculado){i.warning("Los Datos fueron Actualizados. Vuelva a ejecutar Descomponer.");this.calculaComponente();return}var r=this.getView().byId("cantidad");var o=Number(r.getValue().split(".").join("").split(",").join("."));if(o>this.maxValue){i.error("¡Cantidad Supera Actual Stock Disponible!");return}else{var s={Orden:a,Quantity:o};sap.ui.core.BusyIndicator.show();t.create("/DescordenSet",s,{success:function(t){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.success("¡La Orden N° "+t.ROrden+" ha sido Creada!",{title:"Confirmación",onClose:function(){e._onPageNavButtonPress()},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this),error:function(t){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("¡Error al Crear Descomposición!",{title:"Error",onClose:function(){e._onPageNavButtonPress()},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})}}})});