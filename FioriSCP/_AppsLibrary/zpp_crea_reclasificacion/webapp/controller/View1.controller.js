sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,a){"use strict";var r=null;var i="";return e.extend("cl.conchaytoro.zpp_crea_reclasificacion.controller.View1",{onInit:function(){r=this;var e=this.getOwnerComponent().getModel("tres");this.getView().setModel(e,"motivo");var t,a,i=r.getView().byId("enologo");if(sap.ushell){a=sap.ushell.Container.getService("UserInfo");if(a){t=a.getUser().getFirstName();i.setValue(t)}}},onAdd:function(e){if(!this._validaCamposTabla("add")){return}var t=r.getView().byId("centro");var a=r.getView().byId("motivo");var i=r.getView().byId("codOrigen");var s=r.getView().byId("enologo");var l=t.getSelectedKey();var o=a.getSelectedKey();var n=i.getValue();var u=s.getValue();if(l===""||o===""||n===""||u===""){sap.m.MessageBox.warning("¡Favor completar todos los campos de cabecera!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}var c=new sap.m.ColumnListItem({cells:[new sap.m.Input({maxLength:10,liveChange:function(e){var t=e.getSource().getParent().getCells()[0];var a=e.getSource().getParent().getCells()[4];a.removeAllItems();if(l===""){sap.m.MessageBox.warning("¡Seleccione Bodega!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});t.setValue("")}else{if(/^(M?\d{4}-?\d{4})|\d{6}$/.test(t.getValue())){r.handleValidationSuccess(e)}else{r.handleValidationError(e)}}},placeholder:"Ej: 1112-2006",editable:true}),new sap.m.Text({}),new sap.m.Input({required:true,maxLength:12,type:sap.m.Input.Currency,liveChange:this.validaInput,placeholder:"Ej: 5.000",editable:true}),new sap.m.Text({}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,editable:true,change:function(e){var t=e.getSource().getParent().getCells()[0].getValue();var a=r.getView().byId("centro").getSelectedKey();var i=e.getSource().getParent().getCells()[4].getSelectedKey();var s=this.getModel();var l=[];var o=new sap.ui.model.Filter("IMatnr",sap.ui.model.FilterOperator.EQ,t);l.push(o);o=new sap.ui.model.Filter("IWerks",sap.ui.model.FilterOperator.EQ,a);l.push(o);o=new sap.ui.model.Filter("ILgort",sap.ui.model.FilterOperator.EQ,i);l.push(o);s.read("/LoteSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Batch,text:e.Clabs,additionalText:e.Batch})})}.bind(this),filters:l})}}),new sap.m.Input({maxLength:4,type:sap.m.Input.Number,liveChange:function(e){if(!/^\d{4}$/.test(e.getParameter("value"))){e.getSource().setValueState(sap.ui.core.ValueState.Error)}else{e.getSource().setValueState(sap.ui.core.ValueState.Success)}},placeholder:"Ej: 2020",editable:true}),new sap.m.Button({icon:"sap-icon://decline",width:"3em",press:[this._remove,this]})]});var d=r.getView().byId("posTable");d.addItem(c)},validaEn:function(e){var t=r.getView().byId("enologo");var a=t.getValue();if(a===""){t.setValueState(sap.ui.core.ValueState.Error)}else{t.setValueState(sap.ui.core.ValueState.Success)}},selectAlmacen:function(e){var t=r.getView().byId("lote");t.setValue("");var a=r.getView().byId("codOrigen").getValue();var i=r.getView().byId("centro").getSelectedKey();var s=r.getView().byId("almacen").getSelectedKey();var l=this.getOwnerComponent().getModel();var o=[];var n=new sap.ui.model.Filter("IMatnr",sap.ui.model.FilterOperator.EQ,a);o.push(n);n=new sap.ui.model.Filter("IWerks",sap.ui.model.FilterOperator.EQ,i);o.push(n);n=new sap.ui.model.Filter("ILgort",sap.ui.model.FilterOperator.EQ,s);o.push(n);l.read("/LoteSet",{success:function(e){t.destroyItems();e.results.forEach(function(e){var a=new sap.ui.core.ListItem({key:e.Batch,text:e.Clabs+" - "+e.Atwrt,additionalText:e.Batch});t.addItem(a)})}.bind(this),error:function(e){r.handleValidationError3(e)},filters:o})},selectLote:function(e){e.getSource().setValue(e.getSource().getSelectedKey());var t=r.getView().byId("cantidad");t.setValue("");this.clearCells()},validaInput:function(e){var t=r.getView().byId("codOrigen");var a=t.getValue();var i=r.getView().byId("cantidad");if(a===""){sap.m.MessageBox.warning("¡Ingrese Material!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});i.setValue("")}else{r.addDot(e)}r._calculaTotal()},addDot:function(e){if(!/^[\d]+(\.[\d]{3,})*(\,[\d]{1,3})?$/.test(e.getParameter("value"))){e.getSource().setValue(e.getParameter("value"));e.getSource().setValueState(sap.ui.core.ValueState.Error);return}e.getSource().setValueState(sap.ui.core.ValueState.Success);var t=e.getParameter("value");var a=t.split(".").join("");a=a.split(",");var r=a[0].split("").reverse();var i=[];var s="";var l=Math.ceil(r.length/3);for(var o=0;o<l;o++){for(var n=0;n<3;n++){if(r[n+o*3]!==undefined){s+=r[n+o*3]}}i.push(s);s="";if(a[1]!==undefined)e.getSource().setValue(i.join(".").split("").reverse().join("")+","+a[1]);else e.getSource().setValue(i.join(".").split("").reverse().join(""))}},_remove:function(e){var t=r.getView().byId("posTable");t.removeItem(e.getSource().getParent())},_validaCamposTabla:function(e){var t=r.getView().byId("posTable");var a=r.getView().byId("motivo").getSelectedKey();if(t.getItems().length===0)return true;var i=true;t.getItems().forEach(function(t){if(!i){return}if(a!=="10"&&a!=="80"&&e==="add"){sap.m.MessageBox.error("¡Motivo No Permite más de una Posición!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});i=false;return}else{if(t.getCells()[0].getValue()===""||t.getCells()[0].getValueState()!==sap.ui.core.ValueState.Success||t.getCells()[1].getText()===""||t.getCells()[2].getValue()===""||t.getCells()[2].getValueState()!==sap.ui.core.ValueState.Success||t.getCells()[3].getText()===""||t.getCells()[4].getValue()===""||t.getCells()[5].getValue()===""||t.getCells()[5].getValueState()!==sap.ui.core.ValueState.Success){sap.m.MessageBox.error("¡Campos Vacíos o con Datos Erróneos!",{title:"Error en Campos",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});i=false;return}}});return i},_inputMaterial:function(e,t){var a=r.getView().byId("centro");var i=a.getSelectedKey();var s=r.getView().byId("codOrigen");var l=s.getValue();var o=r.getView().byId("almacen");o.removeAllItems();if(i===""){sap.m.MessageBox.warning("¡Favor seleccione Bodega!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});if(t.Matnr===""){sap.m.MessageBox.warning("¡Material No Existe en Bodega Seleccionada!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}l.setValue("")}else{if(/^(M?\d{4}-?\d{4})|\d{6}$/.test(l)){r.handleValidationSuccess2(e)}else{r.handleValidationError2(e)}}},_inputDescript:function(e){var t=r.getView().byId("codOrigen");var a=t.getValue();var i=r.getView().byId("centro").getSelectedKey();var s=r.getView().byId("descripcion");var l=r.getView().byId("almacen");var o="Sin Descripción";var n=this.getOwnerComponent().getModel();n.read("/MaterialSet(Matnr='"+a+"',Werks='"+i+"')",{success:function(e){if(e.Matnr===""){sap.m.MessageBox.warning("¡Material No Existe en Bodega Seleccionada!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{o=e.Maktx;s.setValue(o);var t=[];var r=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,a);t.push(r);r=new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,i);t.push(r);n.read("/AlmacenSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Lgort,text:e.Lgobe,additionalText:e.Lgort});l.addItem(t)})}.bind(this),filters:t})}}.bind(this),error:function(e){var t="hola";return t}})},_descript:function(e){var t=e.getSource().getParent().getCells()[0].getValue();var a=r.getView().byId("centro").getSelectedKey();var s=e.getSource().getParent().getCells()[1];var l=e.getSource().getParent().getCells()[3];var o=e.getSource().getParent().getCells()[4];var n="Sin Descripción";var u=this.getOwnerComponent().getModel();u.read("/MaterialSet(Matnr='"+t+"',Werks='"+a+"')",{success:function(e){if(e.Matnr===""){sap.m.MessageBox.warning("¡Material No Existe en Bodega Seleccionada!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{n=e.Maktx;i=e.Meins;s.setProperty("text",n);l.setProperty("text",i);var r=[];var c=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,t);r.push(c);c=new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,a);r.push(c);u.read("/AlmacenSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Lgort,text:e.Lgobe,additionalText:e.Lgort});o.addItem(t)})}.bind(this),filters:r})}}.bind(this),error:function(e){var t="hola";return t}})},_clearMatnr:function(){this.getView().byId("descripcion").setValue("");this.getView().byId("cantidad").setValue("");this.getView().byId("almacen").setValue("");this.getView().byId("lote").setValue("");this.getView().byId("codOrigen").setSelectedKey("");this.getView().byId("codOrigen").setValueState(sap.ui.core.ValueState.None);this.getView().byId("cantidad").setValueState(sap.ui.core.ValueState.None);this.clearCells()},clearInput:function(e){var t=this.getView().byId("centro");var a=this.getView().byId("motivo");var r=this.getView().byId("codOrigen");var i=this.getView().byId("descripcion");var s=this.getView().byId("cantidad");var l=this.getView().byId("almacen");var o=this.getView().byId("lote");t.setValue("");a.setValue("");r.setValue("");r.setValueState(sap.ui.core.ValueState.None);i.setValue("");s.setValue("");s.setValueState(sap.ui.core.ValueState.None);l.setValue("");o.setValue("");this.clearCells()},clearCells:function(e){var t=this.getView().byId("posTable");t.removeAllItems()},activeButton:function(){var e=this.getView().byId("btnCrear");var t=this.getView().byId("motivo");var a=this.getView().byId("centro");var r=this.getView().byId("codOrigen");var i=this.getView().byId("cantidad");var s=this.getView().byId("enologo");if(t.getSelectedKey()===""||t.getValueState()!==sap.ui.core.ValueState.Success||a.getSelectedKey()===""||a.getValueState()!==sap.ui.core.ValueState.Success||r.getValue()===""||r.getValueState()!==sap.ui.core.ValueState.Success||i.getValue()===""||i.getValueState()!==sap.ui.core.ValueState.Success||s.getValue()===""||s.getValueState()!==sap.ui.core.ValueState.Success){e.setEnabled(false)}else{e.setEnabled(true)}},_calculaTotal:function(){var e=0;var t=this.getView().byId("cantidad");this.getView().byId("posTable").getItems().forEach(function(a){e=e+Number(a.getCells()[2].getValue().split(".").join("").replace(",","."));t.setValue(Intl.NumberFormat("de-DE").format(e))})},_clearChangeMatnr:function(){this.getView().byId("cantidad").setValue("");this.getView().byId("almacen").setValue("");this.getView().byId("lote").setValue("");this.getView().byId("codOrigen").setSelectedKey("");this.getView().byId("codOrigen").setValueState(sap.ui.core.ValueState.None);this.getView().byId("cantidad").setValueState(sap.ui.core.ValueState.None)},onSave:function(e){if(!this._validaCamposTabla("save")){return}var t=r.getView().byId("centro");var a=r.getView().byId("motivo");var i=r.getView().byId("codOrigen");var s=r.getView().byId("cantidad");var l=r.getView().byId("almacen");var o=r.getView().byId("lote");var n=r.getView().byId("enologo");var u=t.getSelectedKey();var c=a.getSelectedKey();var d=i.getValue();var g=s.getValue();var V=l.getSelectedKey();var p=o.getValue();var v=n.getValue();if(u===""||c===""||d===""||g===""||V===""||p===""||v===""){sap.m.MessageBox.warning("¡Favor completar todos los campos de cabecera!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}var h=this;var I=this.getView().byId("centro");var S=this.getView().byId("codOrigen");var y=this.getView().byId("descripcion");var m=this.getView().byId("cantidad");var w=this.getView().byId("posTable");var b=I.getSelectedKey();var f=S.getValue();var C=y.getValue();var x=m.getValue().split(".").join("").replace(",",".");var M=w.getItems();var E=[];M.forEach(function(e){E.push({IAction:"",IAufnr:"",MatnrDestino:e.getCells()[0].getValue(),Aufnr:"",Gjahr:e.getCells()[5].getValue(),DescripPos:e.getCells()[1].getText(),CantPos:e.getCells()[2].getValue().split(".").join("").replace(",","."),Lgort:e.getCells()[4].getSelectedKey()})});var D=this.getOwnerComponent().getModel("dos");var F={ICantCab:x,IDescripCab:C,Motivo:c,IVeraaUser:v,MatnrOrigen:f,Aufnr:"",Batch:p,Werks:b,Lgort:V,Nav_Pos:E};sap.ui.core.BusyIndicator.show();D.create("/CabeceraSet",F,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Aufnr===""){sap.m.MessageBox.error("¡Material No Puede ser Reclasificado!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.success("¡Orden de Reclasificación N° "+e.Aufnr+" ha sido Creada!",{title:"Confirmación",onClose:function(){location.reload(true)},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("¡Error al Crear Orden!",{title:"Error",onClose:"",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})},handleValidationError:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);var t=e.getSource().getParent().getCells()[1];var a=e.getSource().getParent().getCells()[3];t.setProperty("text","");a.setProperty("text","")},handleValidationSuccess:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);r._descript(e)},handleValidationSuccess2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);r._inputDescript(e)},handleValidationError2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);var t=r.getView().byId("descripcion");var a=r.getView().byId("cantidad");var i=r.getView().byId("almacen").setValue("");var s=r.getView().byId("lote").setValue("");a.setValueState(sap.ui.core.ValueState.None);t.setValue("");a.setValue("");i.destroyItems();s.destroyItems();this.clearCells()}})});