/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.model.format.AmountFormat");jQuery.sap.require("sap.ca.ui.model.format.QuantityFormat");jQuery.sap.require("sap.ca.ui.model.type.Date");jQuery.sap.require("ui.s2p.mm.ses.approve.util.Formatter");jQuery.sap.require("ui.s2p.mm.ses.approve.util.QuickView");sap.ca.scfld.md.controller.BaseDetailController.extend("ui.s2p.mm.ses.approve.view.S3",{onInit:function(){var v=this.getView();var t=this;var c=sap.ui.core.Component.getOwnerIdFor(this.getView());if(!this.oApplication){this.oApplication=sap.ca.scfld.md.app.Application.getImpl();this.oResourceBundle=this.oApplication.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this.bBusinessCardLoadRequested=false;this.oBusinessCard={bLoadRequested:false,sCreatedByModel:"createdBy",oPressedControll:null}}this.setupNotes();this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="detail"){var a=new sap.ui.model.Context(v.getModel(),'/'+e.getParameter("arguments").contextPath);v.setBindingContext(a);v.setModel(v.getModel(),"sesHeaderDetail");v.bindElement("sesHeaderDetail>"+a.getPath()+"/SESHeaderDetails",{expand:"SESItems,SESAccountings,Attachments,Notes"});var b=v.getElementBinding("sesHeaderDetail");b.attachDataReceived(this.onS3DataLoaded,this);var C=sap.ui.component(c);C.oEventBus.subscribe("ui.s2p.mm.ses.approve","S2DataReceived",this.handleS2DataReceived,this);this.clearNotes(true);this.handleS2DataReceived()}},this);this.oHeaderFooterOptions={oPositiveAction:{sI18nBtnTxt:"BUTTON_APPROVE_S3",onBtnPressed:jQuery.proxy(t.handleApprove,t)},oNegativeAction:{sI18nBtnTxt:"BUTTON_REJECT_S3",onBtnPressed:jQuery.proxy(t.handleReject,t)},oAddBookmarkSettings:{icon:"sap-icon://home"}};this.setHeaderFooterOptions(this.oHeaderFooterOptions)},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions},handleS2DataReceived:function(e){var w=this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());if(w){if(w.NextRejectCode===""){this.oHeaderFooterOptions.oNegativeAction.bDisabled=true}else{this.oHeaderFooterOptions.oNegativeAction.bDisabled=false}if(w.NextReleaseCode===""){this.oHeaderFooterOptions.oPositiveAction.bDisabled=true}else{this.oHeaderFooterOptions.oPositiveAction.bDisabled=false}this.setHeaderFooterOptions(this.oHeaderFooterOptions)}},handleUpdateFinished:function(e){if((e.getParameter("reason")==="Binding")||(e.getParameter("reason")==="Refresh")||(e.getParameter("reason")==="Change")){var h=e.getSource().getHeaderText();var n=h.indexOf('(');h=h.substring(0,n)+'('+e.getParameter("total")+")";e.getSource().setHeaderText(h)}},handleNavToSubDetail:function(e){this.oRouter.navTo("subDetail",{contextPath:e.getSource().getBindingContext("sesHeaderDetail").getPath().substr(1),backPath:e.getSource().getBindingContext().getPath().substr(1)},true)},onBack:function(){window.history.back()},onS3DataLoaded:function(e){var m=this.getView().getModel("sesHeaderDetail");var c=this.getView().getBindingContext("sesHeaderDetail");if(c&&m){this.bindAttachments(m,c);this.bindNotes(m,c)}},onBusinessCardDataLoaded:function(e){var m=this.getView().getModel("createdBy");if(this.oBusinessCard.bLoadRequested){if(m.getProperty(e.getSource().getPath())){ui.s2p.mm.ses.approve.util.QuickView.EmployeeLaunch(this.oBusinessCard.oPressedControll,this,this.oBusinessCard.sCreatedByModel)}}this.oBusinessCard.bLoadRequested=false},onPurchaseOrderLinkPress:function(){},onCreatedByLinkPress:function(e){this.oBusinessCard.oPressedControll=e.getSource();var w=e.getSource().getBindingContext().getObject();this.launchBusinessCard(w.CreatedByID)},onNoteCreatedByLinkPress:function(e){this.oBusinessCard.oPressedControll=e.getSource()._oLinkControl;var n=e.getSource().getBindingContext("NotesModel").getObject();this.launchBusinessCard(n.CreatedByUser,n)},launchBusinessCard:function(u,o){var b=null;if(!this.getView().getBindingContext(this.oBusinessCard.sCreatedByModel)){this.readBusinessCard(o)}else{b=this.getView().getBindingContext(this.oBusinessCard.sCreatedByModel).getObject();if(b.UserID!==u){this.readBusinessCard(o)}}if(this.getView().getBindingContext(this.oBusinessCard.sCreatedByModel)){b=this.getView().getBindingContext(this.oBusinessCard.sCreatedByModel).getObject();if(b.UserID===u){this.oBusinessCard.bLoadRequested=false;ui.s2p.mm.ses.approve.util.QuickView.EmployeeLaunch(this.oBusinessCard.oPressedControll,this,this.oBusinessCard.sCreatedByModel)}}},readBusinessCard:function(o){this.oBusinessCard.bLoadRequested=true;ui.s2p.mm.ses.approve.util.QuickView.setCreatedByModel(this.getView(),o);var b=this.getView().getElementBinding(this.oBusinessCard.sCreatedByModel);b.attachDataReceived(this.onBusinessCardDataLoaded,this)},buildFileDescriptorObject:function(v){var f;f={name:v.FileName,size:v.FileSize,url:v.__metadata.media_src,uploadedDate:v.CreatedOn,contributor:v.CreatedByUserName,mimeType:v.MimeType,fileId:v.AttachmentGuid};return f},bindAttachments:function(m,c){var p=c.getPath()+"/Attachments";var a=m.getProperty(p);var A={Attachments:[]};var o;var f;for(var i=0;i<a.length;i++){o=m.getProperty("/"+a[i]);f=this.buildFileDescriptorObject(o);A.Attachments.push(f)}this.byId("idFileUpload").setModel(new sap.ui.model.json.JSONModel(A))},bindNotes:function(m,c){var p=c.getPath()+"/Notes";var n=m.getProperty(p);this.bNotesRead=true;var N={Notes:[]};var o;for(var i=0;i<n.length;i++){o=m.getProperty("/"+n[i]);N.Notes.push(o)}N.notesExist=(N.Notes.length>0)?true:false;this.oNotesModel.setData(N)},onNotesReadSuccess:function(d){this.bNotesRead=true;var n={Notes:[]};for(var i=0;i<d.results.length;i++){n.Notes.push(d.results[i])}n.notesExist=(n.Notes.length>0)?true:false;this.oNotesModel.setData(n)},setupNotes:function(){this.bNotesRead=false;var n={notesExist:false,Notes:[]};this.oNotesModel=new sap.ui.model.json.JSONModel(n);this.getView().setModel(this.oNotesModel,"NotesModel")},clearNotes:function(){this.bNotesRead=false;var n={Notes:[]};n.notesExist=false;n.Notes=[];this.oNotesModel.setData(n)},handleAddNote:function(e){},getConfirmationText:function(m){var a=m;var s=this.getView().getBindingContext().getProperty("Description");var c=this.getView().getBindingContext().getProperty("CreatedByName");var S=this.getView().getBindingContext().getProperty("SESNumber");var d=String.fromCharCode(34);s=d+s+d+" ("+S+")";a=a.replace("{0}",s);a=a.replace("{1}",c);return a},handleApprove:function(){this.oWorkItem=this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());this.bApprove=true;sap.ca.ui.dialog.confirmation.open({question:this.getConfirmationText(this.getView().getModel("i18n").getResourceBundle().getText("MSGBX_APPROVE_TEXT")),showNote:false,title:this.getView().getModel("i18n").getResourceBundle().getText("MSG_APPROVE_TITLE"),confirmButtonLabel:this.getView().getModel("i18n").getResourceBundle().getText("BUTTON_YES_S3")},jQuery.proxy(this.executeApproveReject,this))},handleReject:function(){this.oWorkItem=this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());this.bApprove=false;sap.ca.ui.dialog.confirmation.open({question:this.getConfirmationText(this.getView().getModel("i18n").getResourceBundle().getText("MSGBX_REJECT_TEXT")),showNote:true,title:this.getView().getModel("i18n").getResourceBundle().getText("MSG_REJECT_TITLE"),confirmButtonLabel:this.getView().getModel("i18n").getResourceBundle().getText("BUTTON_YES_S3")},jQuery.proxy(this.executeApproveReject,this));var t=sap.ui.getCore().byId('CA_VIEW_CONFIRM--TXA_NOTE');if(t){t.setMaxLength(255)}},executeApproveReject:function(r){if(r.isConfirmed){var p={};if(this.oWorkItem.SAP__Origin){p.SAP__Origin=this.oWorkItem.SAP__Origin}p.SESNumber=this.oWorkItem.SESNumber;if(this.bApprove){p.ReleaseCode=this.oWorkItem.NextReleaseCode;this.sTextKey="MSGTX_SUCCESSFUL_APPROVE";this.oDataModel.setRefreshAfterChange(false);this.oDataModel.callFunction("approveServiceEntrySheet","POST",{SAP__Origin:this.oWorkItem.SAP__Origin,SESNumber:this.oWorkItem.SESNumber,ReleaseCode:this.oWorkItem.NextReleaseCode},undefined,jQuery.proxy(this.approveRejectSuccessCallback,this),jQuery.proxy(this.onRequestFailed,this))}else{p.ReleaseCode=this.oWorkItem.NextRejectCode;p.RejectDescription="";if(r.sNote){p.RejectDescription=r.sNote}this.sTextKey="MSGTX_SUCCESSFUL_REJECT";this.oDataModel.setRefreshAfterChange(false);this.oDataModel.callFunction("rejectServiceEntrySheet","POST",{SAP__Origin:this.oWorkItem.SAP__Origin,SESNumber:this.oWorkItem.SESNumber,ReleaseCode:this.oWorkItem.NextRejectCode,RejectionText:p.RejectDescription},undefined,jQuery.proxy(this.approveRejectSuccessCallback,this),jQuery.proxy(this.onRequestFailed,this))}}},approveRejectSuccessCallback:function(){var t=this.getConfirmationText(this.oResourceBundle.getText(this.sTextKey));var c=sap.ui.core.Component.getOwnerIdFor(this.getView());var C=sap.ui.component(c);this.getView().unbindElement();C.oEventBus.publish("ui.s2p.mm.ses.approve","asesApproveRejectForward");this.oDataModel.setRefreshAfterChange(true);this.oDataModel.refresh(true);sap.ca.ui.message.showMessageToast(t)},onRequestFailed:function(e){var m=jQuery.parseJSON(e.response.body);var M=m.error.message.value;if(m.error.innererror.errordetails.length>=0){M=m.error.innererror.errordetails[0].message}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:M,details:e.response.body})}});
