sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/library","cl/conchaytoro/zmm_entrada_vino/model/formatter"],function(e,t,i,s){"use strict";return e.extend("cl.conchaytoro.zmm_entrada_vino.controller.Detail",{formatter:s,onInit:function(){var e=this.byId("lineItemsList");this._oList=e;var i=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(i,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this.initView();this.addViewController("detail",this)},initView:function(){this.setToDay();this.setPositionListItem(0)},onRefresh:function(){this._oList.getBinding("items").refresh()},navButtonPress:function(e){},setToDay:function(){var e=this.getView().byId("fecha");var t=new Date;e.setDateValue(t);e.setMinDate(t);e.setMaxDate(t)},setPositionListItem:function(e){if(e!==undefined&&e!==""){var t=parseInt(e,10);var i=this.byId("lineItemsList").getItems();if(i.length>0){i[t].firePress()}}},clearValues:function(e){var t=this.byId("lineItemsList");var i=t.getItems();i.forEach(function(e){e.getCells()[5].setSelected(false)});if(e!=="undefined"&&e==="full"){var s=this.byId("objectHeader");var n=this.byId("fecha");n.setValue("");s.setNumber("");s.setNumberUnit("")}},onShareEmailPress:function(){var e=this.getModel("detailView");sap.m.URLHelper.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onListUpdateFinished:function(e){var t,i=e.getParameter("total"),s=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(i){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[i])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}s.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;if(!t){return}this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("EntradaHeaderSet",{Ebeln:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var i=t.getPath(),s=this.getResourceBundle(),n=e.getModel().getObject(i),a=n.Ebeln,r=n.Ebeln,o=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(i);o.setProperty("/shareSendEmailSubject",s.getText("shareSendEmailObjectSubject",[a]));o.setProperty("/shareSendEmailMessage",s.getText("shareSendEmailObjectMessage",[r,a,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),i=this.byId("lineItemsList"),s=i.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);i.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",s)});t.setProperty("/busy",true);t.setProperty("/delay",e)},yearInput:function(e){if(!/^\d{4}$/.test(e.getParameter("value"))){e.getSource().setValueState(sap.ui.core.ValueState.Error)}else{e.getSource().setValueState(sap.ui.core.ValueState.Success)}},onContabilizarPress:function(e){var t=this.getView().getModel();var i=sap.ui.getCore().byId("zmm_entrada_vino---master--list");var s=this.byId("lineItemsList");var n=s.getItems();var a=[];var r=this;var o=this.getView().byId("objectHeader").getNumber();var l=this.getView().byId("objectHeader").getNumberUnit();n.forEach(function(e){if(e.getCells()[6].getSelected()){a.push({Ebeln:o,Ebelp:e.getCells()[0].getText(),Matnr:e.getCells()[1].getText(),Menge:e.getCells()[3].getText(),Meins:e.getCells()[4].getUnit(),Gjahr:e.getCells()[5].getValue()})}});if(n.length>0){var d={Ebeln:o,Aedat:l,HeaderToItems:a};sap.ui.core.BusyIndicator.show();t.create("/EntradaHeaderSet",d,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Ebeln!==""){sap.m.MessageBox.success("¡Plan de Entrega N° "+e.Ebeln+" ha sido Contabilizado!",{title:"Confirmación",onClose:function(){s.getBinding("items").refresh(true);var e=s.getItems().length;if(e===1){i.getBinding("items").refresh(true);var t=i.getItems().length;if(t>=1){i.getItems()[0].firePress()}r.clearValues("full")}else{r.clearValues()}},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{if(e.Message!==""){sap.m.MessageBox.warning(e.Message,{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.warning("¡Error al Contabilizar!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Ocurrio un error en la contabilización!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})}},onCancelarPress:function(e){this.clearValues()},onNavBack:function(){this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")}})});