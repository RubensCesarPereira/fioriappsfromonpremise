sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,a){"use strict";var r=null;var i="";return e.extend("conchaytoro.cl.zsd_crear_solicitud_vino.controller.View1",{onInit:function(){r=this;var e=new t;this.getView().setModel(e,"aux");this.fecha();var a={solicitud:[{name:"ZTCE",value:"Traslado Centro Enología"},{name:"ZTRI",value:"Traslado Intercompany"}]};var i=new t(a);this.getView().setModel(i,"rr")},onBeforeRendering:function(){},fecha:function(){var e=this.getView().byId("fecha");var t=new Date;e.setDateValue(t);e.setMinDate(t)},_position:function(){var e=0;var t=this.getView().byId("posTable");e=t.getItems().length;e=(e+1)*10;return e},_descript:function(e){var t=e.getSource().getParent().getCells()[2].getValue();var a=e.getSource().getParent().getCells()[4];a.removeAllItems();var s=e.getSource().getParent().getCells()[1].getSelectedKey();var l=r.getView().byId("centro").getSelectedKey();var o=e.getSource().getParent().getCells()[3];var n=e.getSource().getParent().getCells()[7];var u="Sin Descripción";var c=this.getOwnerComponent().getModel();c.read("/MaterialSet(Matnr='"+t+"',Werks='"+s+"')",{success:function(e){if(e.Matnr===""){sap.m.MessageBox.warning("¡Material no existe en Centro de Destino!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{c.read("/MaterialSet(Matnr='"+t+"',Werks='"+l+"')",{success:function(e){if(e.Matnr===""){sap.m.MessageBox.warning("¡Material no Existe en Centro Suministrador!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{u=e.Maktx;i=e.Meins;o.setProperty("text",u);n.setProperty("text",i);var r=[];var l=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,t);r.push(l);l=new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,s);r.push(l);c.read("/AlmacenSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Lgort,text:e.Lgobe,additionalText:e.Lgort});a.addItem(t)})}.bind(this),filters:r})}}.bind(this),error:function(e){sap.m.MessageBox.error(e.message,{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})}}.bind(this),error:function(e){sap.m.MessageBox.error(e.message,{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},onAdd:function(e){if(!this._validaCamposTabla()){return}var t=r.getView().byId("centro");var a=r.getView().byId("grupo");var i=t.getSelectedKey();var s=a.getSelectedKey();if(i===""||s===""){sap.m.MessageBox.warning("¡Favor Completar todos los Campos de Cabecera!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}sap.ui.core.BusyIndicator.show();var l=this._position();var o=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:l}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,items:{path:"/CentroSet",sorter:{path:"Werks"},template:new sap.ui.core.ListItem({key:"{Werks}",text:"{Name1}",additionalText:"{Werks}"})},editable:true}),new sap.m.Input({maxLength:10,liveChange:function(e){var t=e.getSource().getParent().getCells()[1].getSelectedKey();var a=e.getSource().getParent().getCells()[2];if(t===""){sap.m.MessageBox.warning("¡Seleccione Centro de Destino!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});a.setValue("")}else{if(/^(M?\d{4}-?\d{4})|\d{6}$/.test(a.getValue())){r.handleValidationSuccess(e)}else{r.handleValidationError(e)}}},placeholder:"Ej: 2135-2019",editable:true}),new sap.m.Text({}),new sap.m.ComboBox({}),new sap.m.Input({maxLength:4,type:sap.m.Input.Number,placeholder:"Ej: 2020",editable:true}),new sap.m.Input({required:true,maxLength:12,type:sap.m.Input.Currency,liveChange:this.validaInput,placeholder:"Ej: 5.000",editable:true}),new sap.m.Text({}),new sap.m.DatePicker({valueFormat:"dd.MM.yyyy",displayFormat:"dd.MM.yyyy",required:true,validationError:"handleValidationError2",validationSuccess:"handleValidationSuccess2",editable:true,change:this.handleDate,minDate:new Date}),new sap.m.Input({maxLength:20,placeholder:"",editable:true}),new sap.m.Button({icon:"sap-icon://decline",width:"3em",press:[this.remove,this]})]});var n=r.getView().byId("posTable");n.addItem(o);sap.ui.core.BusyIndicator.hide()},validaInput:function(e){var t=e.getSource().getParent().getCells()[1].getSelectedKey();var a=e.getSource().getParent().getCells()[6];if(t===""){sap.m.MessageBox.warning("¡Seleccione Centro de Destino!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});a.setValue("")}else{r.addDot(e)}},addDot:function(e){if(!/^[\d]+(\.[\d]{3,})*(\,[\d]{1,3})?$/.test(e.getParameter("value"))){e.getSource().setValue(e.getParameter("value"));e.getSource().setValueState(sap.ui.core.ValueState.Error);return}e.getSource().setValueState(sap.ui.core.ValueState.Success);var t=e.getParameter("value");var a=t.split(".").join("");a=a.split(",");var r=a[0].split("").reverse();var i=[];var s="";var l=Math.ceil(r.length/3);for(var o=0;o<l;o++){for(var n=0;n<3;n++){if(r[n+o*3]!=undefined){s+=r[n+o*3]}}i.push(s);s="";if(a[1]!==undefined)e.getSource().setValue(i.join(".").split("").reverse().join("")+","+a[1]);else e.getSource().setValue(i.join(".").split("").reverse().join(""))}},clearInput:function(e){var t=this.getView().byId("solicitud");var a=this.getView().byId("centro");var r=this.getView().byId("grupo");var i=this.getView().byId("fecha");t.setValue("");a.setValue("");r.setValue("");i.setValue("")},clearCells:function(e){var t=this.getView().byId("posTable");t.removeAllItems()},_clearMatnr:function(){this.getView().byId("grupo").setValue("");this.clearCells()},onSave:function(e){if(!this._validaCamposTabla()){return}var t=this;var a=this.getView().byId("centro");var r=this.getView().byId("grupo");var i=this.getView().byId("fecha");var s=this.getView().byId("posTable");var l=a.getSelectedKey();var o=r.getSelectedKey();var n=i.getValue();var u=s.getItems();var c=[];u.forEach(function(e){c.push({Purchaseorder:"",PoItem:e.getCells()[0].getText(),ShortText:e.getCells()[3].getText(),Material:e.getCells()[2].getValue(),Plant:e.getCells()[1].getSelectedKey(),StgeLoc:e.getCells()[4].getSelectedKey(),Quantity:e.getCells()[6].getValue(),PoUnit:e.getCells()[7].getText(),CreatDate:e.getCells()[8].getValue(),Texto1:e.getCells()[5].getValue(),Texto2:e.getCells()[9].getValue()})});var g=this.getOwnerComponent().getModel("dos");var d={Purchaseorder:"",CreatDate:n,DocType:"ZTCE",PurchOrg:"",PurGroup:o,SupplPlnt:l,PedidoToPosiciones:c};sap.ui.core.BusyIndicator.show();g.create("/PedidoSet",d,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Purchaseorder===""){sap.m.MessageBox.error("¡No fue Posible Crear Solicitud!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.success("¡El pedido N° "+e.Purchaseorder+" ha sido Creado!",{title:"Confirmación",onClose:function(){t.clearInput();t.clearCells()},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("¡Error al Crear Solicitud!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})},handleValidationError:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);var t=e.getSource().getParent().getCells()[3];var a=e.getSource().getParent().getCells()[7];t.setProperty("text","");a.setProperty("text","")},handleValidationSuccess:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);r._descript(e)},handleValidationError2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);this.validaInput()},handleValidationSuccess2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);this.validaInput()},onSelectionChange:function(e){var t=this.getOwnerComponent().getModel("dos");var a=e.getParameter("listItem");t=a.getBindingContext().getObject()},edit:function(e){if(e.getSource().getProperty("icon")==="sap-icon://edit"){e.getSource().setProperty("icon","sap-icon://accept");var t=e.getSource().getParent();t.getCells().forEach(function(e){if(e.getMetadata()._sClassName==="sap.m.Input"){e.setEnabled(true);e.setEditable(true)}})}else{e.getSource().setProperty("icon","sap-icon://edit");var t=e.getSource().getParent();t.getCells().forEach(function(e){if(e.getMetadata()._sClassName==="sap.m.Input"){e.setEnabled(false);e.setEditable(false)}})}},remove:function(e){var t=r.getView().byId("posTable");t.removeItem(e.getSource().getParent())},_validaCamposTabla:function(){var e=r.getView().byId("posTable");if(e.getItems().length===0)return true;var t=true;e.getItems().forEach(function(e){if(!t){return}if(e.getCells()[1].getSelectedKey()===""||e.getCells()[2].getValue()===""||e.getCells()[2].getValueState()!==sap.ui.core.ValueState.Success||e.getCells()[3].getText()===""||e.getCells()[4].getSelectedKey()===""||e.getCells()[5].getValue()===""||e.getCells()[6].getValue()===""||e.getCells()[6].getValueState()!==sap.ui.core.ValueState.Success||e.getCells()[7].getText()===""||e.getCells()[8].getDateValue()===null||e.getCells()[8].getProperty("valueState")!==sap.ui.core.ValueState.None||!/^\d{2}.\d{2}.\d{4}$/.test(e.getCells()[8].getValue())){t=false;return}});if(!t)sap.m.MessageBox.error("¡Campos Vacíos o con Datos Erróneos!. Favor actualizar campos.",{title:"Error en campos",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return t},handleDate:function(e){var t=e.getSource();var a=e.getParameter("valid");if(a){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error)}}})});