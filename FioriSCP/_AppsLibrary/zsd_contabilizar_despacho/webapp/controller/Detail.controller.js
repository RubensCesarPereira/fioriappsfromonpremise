sap.ui.define(["conchaytoro/cl/zsd_contabilizar_despacho/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","conchaytoro/cl/zsd_contabilizar_despacho/model/formatter"],function(e,t,a,r){"use strict";var s=null;return e.extend("conchaytoro.cl.zsd_contabilizar_despacho.controller.Detail",{formatter:r,onInit:function(){$.contSub=9e5;s=this;var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));var a=this.getOwnerComponent().getModel("tres");a.setSizeLimit("500");var r=this.getView().byId("btnConta");r.setEnabled(false)},selecPatCamion:function(e){this.getView().byId("patenteCar").setSelectedKey("");this.getView().byId("patenteCam").setSelectedKey("");this.getView().byId("capacidad").setValue("");var t=this.getView().byId("patenteCam");var a=e.getSource().getParent().getParent().getContent()[3].getItems()[1];var r=e.getSource().getSelectedKey();var s=this.getOwnerComponent().getModel("tres");var i=[];var l=new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.EQ,r);i.push(l);l=new sap.ui.model.Filter("Parvw",sap.ui.model.FilterOperator.EQ,"VH");i.push(l);s.read("/TransportistaSet",{success:function(e){var r=new sap.ui.model.json.JSONModel(e.results);t.setModel(r,"cam");var s=t.getBinding("items");s.filter(new sap.ui.model.Filter("Parvw",sap.ui.model.FilterOperator.EQ,"VH"));r=new sap.ui.model.json.JSONModel(e.results);a.setModel(r,"car");s=a.getBinding("items");s.filter(new sap.ui.model.Filter("Parvw",sap.ui.model.FilterOperator.EQ,"VV"))}.bind(this),error:function(e){var t="Error en el Servicio";return t}.bind(this),filters:i})},selectPatCarro:function(e){var t=this.getView().byId("capacidad");var a=e.getSource().getSelectedKey();var r=this.getOwnerComponent().getModel("tres");var s=[];var i=new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.EQ,a);s.push(i);i=new sap.ui.model.Filter("Parvw",sap.ui.model.FilterOperator.EQ,"VV");s.push(i);r.read("/TransportistaSet",{success:function(e){var a=e.results[0].Name2;t.setValue(a)}.bind(this),filters:s})},clearInput:function(e){this._selectFirst();var t=this.getView().byId("lineItemsList");var a=t.getItems();var r=this.getView().byId("trans");var s=this.getView().byId("patenteCam");var i=this.getView().byId("capacidad");var l=this.getView().byId("sellos");var o=this.getView().byId("patenteCar");var n=this.getView().byId("chofer");var u=this.getView().byId("rut");var c=this.getView().byId("cubaOri");var g=this.getView().byId("densidad");var d=this.getView().byId("pesoTara");var p=this.getView().byId("pesoBru");r.setValue("");s.setValue("");i.setValue("");o.setValue("");n.setValue("");u.setValue("");c.setValue("");g.setValue("");d.setValue("");p.setValue("");l.setValue("");r.setValueState(sap.ui.core.ValueState.None);s.setValueState(sap.ui.core.ValueState.None);o.setValueState(sap.ui.core.ValueState.None);n.setValueState(sap.ui.core.ValueState.None);u.setValueState(sap.ui.core.ValueState.None);g.setValueState(sap.ui.core.ValueState.None);d.setValueState(sap.ui.core.ValueState.None);p.setValueState(sap.ui.core.ValueState.None);a.forEach(function(e){if(e.getCells()[0].getText().substring(0,1)!=="9"){e.getCells()[11].setValue("");e.getCells()[11].setValueState(sap.ui.core.ValueState.None);e.getCells()[12].setSelected(false)}})},_selectFirst:function(){this.getView().getParent().getParent().getMasterPages()[0].getContent()[0].getContent()[1].getItems()[0].firePress()},validaCheck:function(e){var t=this.getView().byId("btnConta");if(e.getSource().getProperty("selected")){if(e.getSource().getParent().getCells()[11].getValueState()===sap.ui.core.ValueState.None){a.show("¡Favor Ingresar Grado Alcohólico!");e.getSource().getParent().getCells()[11].setValueState(sap.ui.core.ValueState.Error)}if(e.getSource().getParent().getCells()[11].getValueState()===sap.ui.core.ValueState.Success){t.setEnabled(true)}}else{if(e.getSource().getParent().getCells()[11].getValue()!==""){e.getSource().getParent().getCells()[11].setValue("");e.getSource().getParent().getCells()[11].setValueState(sap.ui.core.ValueState.None)}else{e.getSource().getParent().getCells()[11].setValueState(sap.ui.core.ValueState.None)}}},_almacen:function(e,t){var a=this.getView().byId("lineItemsList");var r=s.getView().byId("codCentro").getText();var i=t;var l=a.getItems()[e].getCells()[3];var o=s.getOwnerComponent().getModel("tres");var n=[];var u=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,i);n.push(u);u=new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,r);n.push(u);o.read("/AlmacenSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Lgort,text:e.Lgobe,additionalText:e.Lgort});l.addItem(t)})}.bind(this),filters:n,error:function(e){var t="hola";return t}})},_remove:function(e){var t=s.getView().byId("lineItemsList");t.removeItem(e.getSource().getParent())},_validaCamposTabla:function(){var e=s.getView().byId("lineItemsList");if(e.getItems().length===0)return true;var t=true;e.getItems().forEach(function(e){if(e.getCells()[12].getMetadata()._sClassName!=="sap.m.CheckBox"){if(e.getCells()[3].getSelectedKey()===""||e.getCells()[4].getSelectedKey()===""||e.getCells()[6].getValue()===""||e.getCells()[6].getValueState()!==sap.ui.core.ValueState.Success){t=false;return}}});if(!t)sap.m.MessageBox.error("¡No es posible Agregar, campos Vacíos o con datos Erróneos!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return t},onAdd:function(e){$.contSub+=1;if(!this._validaCamposTabla()){return}var t=this.getView().byId("lineItemsList");var a=t.getItems();var r=e.getSource().getBindingContext().getObject().Material;var i=e.getSource().getBindingContext().getObject().ShortText;var l=e.getSource().getParent().getParent().indexOfItem(e.getSource().getParent());var o=l+1;var n=1;for(var u=l+1;u<=a.length;u++){if(a[u]===undefined){var c=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:$.contSub}),new sap.m.Text({text:r}),new sap.m.Text({text:i}),new sap.m.ComboBox({change:function(e){var t=e.getSource().getParent().getCells()[1].getText();var a=s.getView().byId("codCentro").getText();var r=e.getSource().getParent().getCells()[3].getSelectedKey();var i=e.getSource().getParent().getCells()[4];var l=this.getModel("tres");var o=[];var n=new sap.ui.model.Filter("IMatnr",sap.ui.model.FilterOperator.EQ,t);o.push(n);n=new sap.ui.model.Filter("IWerks",sap.ui.model.FilterOperator.EQ,a);o.push(n);n=new sap.ui.model.Filter("ILgort",sap.ui.model.FilterOperator.EQ,r);o.push(n);l.read("/LoteSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Batch,text:e.Clabs+" - "+e.Atwrt,additionalText:e.Batch,customData:[new sap.ui.core.CustomData({key:e.Atwrt}),new sap.ui.core.CustomData({key:e.Clabs})]});i.addItem(t)})}.bind(this),filters:o})}}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,editable:true,change:function(e){e.getSource().setValue(e.getSource().getSelectedKey());var t=e.getSource().getSelectedItem().getCustomData()[0].getKey();e.getSource().getParent().getCells()[5].setText(t)}}),new sap.m.Text({}),new sap.m.Input({liveChange:this.addDot}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Button({icon:"sap-icon://decline",width:"2em",press:[this._remove,this]})]});t.insertItem(c,o);break}else{if(a[u].getCells()[0].getText().substring(0,1)!=="9"){var c=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:$.contSub}),new sap.m.Text({text:r}),new sap.m.Text({text:i}),new sap.m.ComboBox({change:function(e){var t=e.getSource().getParent().getCells()[1].getText();var a=s.getView().byId("codCentro").getText();var r=e.getSource().getParent().getCells()[3].getSelectedKey();var i=e.getSource().getParent().getCells()[4];var l=this.getModel("tres");var o=[];var n=new sap.ui.model.Filter("IMatnr",sap.ui.model.FilterOperator.EQ,t);o.push(n);n=new sap.ui.model.Filter("IWerks",sap.ui.model.FilterOperator.EQ,a);o.push(n);n=new sap.ui.model.Filter("ILgort",sap.ui.model.FilterOperator.EQ,r);o.push(n);l.read("/LoteSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Batch,text:e.Clabs+" - "+e.Atwrt,additionalText:e.Batch,customData:[new sap.ui.core.CustomData({key:e.Atwrt}),new sap.ui.core.CustomData({key:e.Clabs})]});i.addItem(t)})}.bind(this),filters:o})}}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,editable:true,change:function(e){e.getSource().setValue(e.getSource().getSelectedKey());var t=e.getSource().getSelectedItem().getCustomData()[0].getKey();e.getSource().getParent().getCells()[5].setText(t)}}),new sap.m.Text({}),new sap.m.Input({liveChange:this.addDot}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Text({}),new sap.m.Button({icon:"sap-icon://decline",width:"2em",press:[this._remove,this]})]});t.insertItem(c,o);break}else{n++;o++;continue}}}this._almacen(o,r)},validaTolerancia:function(e){var t=.05;var a=0;t=e*.05;a=e+t;return a},validaDespacho:function(){var e=0;var t=this.getView().byId("lineItemsList");var r=t.getItems();var s=0;var i=null;var l=false;for(var o=0;o<r.length;o++){if(r[o].getCells()[12].getMetadata()._sClassName==="sap.m.CheckBox"){if(e!==0){if(e>s){a.show("¡Despacho Mayor al Pendiente!");return false}}if(l){a.show("¡Posición seleccionada Sin partición!");return false}if(r[o].getCells()[12].getSelected()){if(r[o].getCells()[11].getValueState()==="Error"){a.show("¡Material Sin grado alcohólico!");return false}i=true;e=0;s=this.validaTolerancia(Number(r[o].getCells()[7].getText().split(".").join("")));l=true}else{i=false}}else{if(i){if(r[o].getCells()[3].getSelectedItem()===null||r[o].getCells()[4].getSelectedItem()===null||r[o].getCells()[6].getValue()===""){a.show("¡Faltan Datos de Partición!");return false}l=false;var n=Number(r[o].getCells()[6].getValue().split(".").join(""));var u=Number(r[o].getCells()[4].getSelectedItem().getCustomData()[1].getKey());if(n>u){r[o].getCells()[6].setValueState("Error");a.show("¡Cantidad Mayor a Cantidad de Lote!");return false}e+=n}}}if(l){a.show("¡Posición seleccionada Sin partición!");return false}if(e>s){a.show("¡Cantidad a Despachar Supera la Tolerancia!");return false}else{return true}},onContabilizar:function(e){if(!this._validaCampos()){return}if(this.getView().byId("lineItemsList").getBindingInfo("items").binding.aKeys.length===this.getView().byId("lineItemsList").getItems().length){a.show("¡No se han creado particiones!");return}if(!this.validaDespacho()){return}var t=this;var r=e.getSource().getParent().getParent().getParent().getParent().getParent().getMasterPages()[0].getContent()[0].getContent()[1];var s=this.getView().byId("objectHeader");var i=this.getView().byId("trans");var l=this.getView().byId("patenteCam");var o=this.getView().byId("sellos");var n=this.getView().byId("patenteCar");var u=this.getView().byId("chofer");var c=this.getView().byId("rut");var g=s.getNumber();var d=i.getSelectedKey();var p=l.getSelectedKey();var h=o.getValue();var m=n.getSelectedKey();var v=u.getValue();var C=c.getValue();var f=this.getView().byId("cubaOri").getValue();var V=this.getView().byId("densidad").getValue();var S=this.getView().byId("pesoTara").getValue();var w=this.getView().byId("pesoBru").getValue();var I=-1;var y=this.getView().byId("lineItemsList");var b=y.getItems();var x=[];var T=[];var P=false;for(var E=0;E<b.length;E++){if(b[E].getCells()[12].getMetadata()._sClassName==="sap.m.CheckBox"){if(b[E].getCells()[12].getSelected()){P=true;I=b[E].getCells()[0].getText();x.push({Vbeln:g,Posnr:b[E].getCells()[0].getText(),Matnr:b[E].getCells()[1].getTitle(),Grado:b[E].getCells()[11].getValue()})}else{P=false}}else{if(P){T.push({Vbeln:g,Posnr:I,Uecha:b[E].getCells()[0].getText(),Matnr:b[E].getCells()[1].getText(),Lfimg:b[E].getCells()[6].getValue().split(".").join("").split(",").join("."),Lgort:b[E].getCells()[3].getSelectedItem().getKey(),Charg:b[E].getCells()[4].getSelectedItem().getKey()})}}}var M=this.getOwnerComponent().getModel("dos");var B={Vbeln:g,Bolnr:v,Traid:C,Parn1:d,Parn2:p,Parn3:m,Text1:f,Text2:V,Text3:w,Text4:S,Text5:h,EntregaToPosiciones:x,EntregaToSubPos:T};sap.ui.core.BusyIndicator.show();M.create("/EntregaSet",B,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Vbeln===""){sap.m.MessageBox.error(e.ExMsg,{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.success("¡La Entrega N° "+e.Vbeln+" ha sido Contabilizada!",{title:"Confirmación",onClose:function(){t.clearInput();r.getBinding("items").refresh(true)},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Error al Crear Despacho.",{title:"Error",onClose:{},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})},_getCaracteristica:function(e){var t=sap.ui.getCore().byId("charact");t.destroyItems();t.setEnableBusyIndicator(true);var a=this.getOwnerComponent().getModel("cuatro");var r=[];var s=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,e);r.push(s);a.read("/CaracteristicaSet",{filters:r,success:function(a){if(a.length!==0){t.setEnableBusyIndicator(false);a.results.forEach(function(a){var r=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:a.CharactDescr}),new sap.m.Text({text:a.ValueChar}),new sap.m.Text({text:a.Updkz}),new sap.m.Text({text:e}),new sap.m.Text({text:a.Charact})]});t.addItem(r)})}else{t.setEnableBusyIndicator(false);sap.m.MessageBox.warning("¡Característica No Encontrada",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}.bind(this),error:function(e){t.setEnableBusyIndicator(false);sap.m.MessageBox.error("¡No se Encontraron Características!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},_getDialog:function(){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("conchaytoro.cl.zsd_contabilizar_despacho.view.Detalle",this);this.getView().addDependent(this._oDialog)}return this._oDialog},viewDetail:function(e){this._getDialog().open();this._getCaracteristica(e.getSource().getParent().getCells()[1].getTitle())},onGuardar:function(e){var t=sap.ui.getCore().byId("charact");var a=t.getItems();var r={};var s=this.getOwnerComponent().getModel("cuatro");a.forEach(function(e){if(e.getCells()[2].getValue()==="U"){r={Matnr:e.getCells()[3].getValue(),Charact:e.getCells()[4].getText(),ValueChar:e.getCells()[1].getValue()};var t="/CaractChangeSet('"+r.Matnr+"')";sap.ui.core.BusyIndicator.show();s.update(t,r,{success:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.success("¡Grado Alcohólico Actualizado!",{title:"Confirmación",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})},error:function(e){sap.m.MessageBox.error("Error al Actualizar",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})}})},_onGuardar:function(e){var t=sap.ui.getCore().byId("charact");var a=t.getItems();var r={};a.forEach(function(e){if(e.getCells()[2].getText()==="U"){r={IMatnr:e.getCells()[3].getText(),IUpdkz:"U",Charact:e.getCells()[0].getText(),ValueChar:e.getCells()[1].getValue(),CharactDescr:"",Updkz:"X",Message:""}}});var s=this.getOwnerComponent().getModel("cuatro");sap.ui.core.BusyIndicator.show();s.update("/CaracteristicaSet",r,{success:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.success("¡Característica Actualizada!",{title:"Confirmación",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Error al Actualizar",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},onCancel:function(){this._getDialog().close()},onShareEmailPress:function(){var e=this.getModel("detailView");sap.m.URLHelper.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onListUpdateFinished:function(e){var t,a=e.getParameter("total"),r=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(a){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[a])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}r.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("PedidoSet",{Purchaseorder:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var a=t.getPath(),r=this.getResourceBundle(),s=e.getModel().getObject(a),i=s.Purchaseorder,l=s.Purchaseorder,o=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(a);o.setProperty("/shareSendEmailSubject",r.getText("shareSendEmailObjectSubject",[i]));o.setProperty("/shareSendEmailMessage",r.getText("shareSendEmailObjectMessage",[l,i,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),a=this.byId("lineItemsList"),r=a.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);a.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",r)});t.setProperty("/busy",true);t.setProperty("/delay",e)},addDot:function(e){if(!/^[\d]+(\.[\d]{3,})*(\,[\d]{1,3})?$/.test(e.getParameter("value"))){e.getSource().setValue(e.getParameter("value"));e.getSource().setValueState(sap.ui.core.ValueState.Error);return}e.getSource().setValueState(sap.ui.core.ValueState.Success);var t=e.getParameter("value");var a=t.split(".").join("");a=a.split(",");var r=a[0].split("").reverse();var s=[];var i="";var l=Math.ceil(r.length/3);for(var o=0;o<l;o++){for(var n=0;n<3;n++){if(r[n+o*3]!==undefined){i+=r[n+o*3]}}s.push(i);i="";if(a[1]!==undefined)e.getSource().setValue(s.join(".").split("").reverse().join("")+","+a[1]);else e.getSource().setValue(s.join(".").split("").reverse().join(""))}},_validaCampos:function(){var e=this.getView().byId("objectHeader");var t=this.getView().byId("trans");var a=this.getView().byId("patenteCam");var r=this.getView().byId("patenteCar");var s=this.getView().byId("chofer");var i=this.getView().byId("rut");var l=this.getView().byId("cubaOri");var o=this.getView().byId("cubaDes");var n=this.getView().byId("pesoNeto");var u=this.getView().byId("pesoBru");var c=e.getNumber();var g=t.getSelectedKey();var d=a.getSelectedKey();var p=r.getSelectedKey();var h=s.getValue();var m=i.getValue();var v=true;if(g===""){t.setValueState(sap.ui.core.ValueState.Error);v=false}else{t.setValueState(sap.ui.core.ValueState.Success)}if(d===""){a.setValueState(sap.ui.core.ValueState.Error);v=false}else{a.setValueState(sap.ui.core.ValueState.Success)}if(p===""){r.setValueState(sap.ui.core.ValueState.Error);v=false}else{r.setValueState(sap.ui.core.ValueState.Success)}if(h===""){s.setValueState(sap.ui.core.ValueState.Error);v=false}else{s.setValueState(sap.ui.core.ValueState.Success)}if(m===""||!/^\d{1,2}.\d{3}.\d{3}-[\d-K]$/.test(m)){i.setValueState(sap.ui.core.ValueState.Error);v=false}else{i.setValueState(sap.ui.core.ValueState.Success)}if(v){var C=0;this.getView().byId("lineItemsList").getItems().forEach(function(e){if(e.getCells()[12].getMetadata()._sClassName==="sap.m.CheckBox"){if(e.getCells()[12].getSelected()){C++}}});if(C===0){v=false;sap.m.MessageBox.error("¡Seleccione al menos una Posición!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}return v}})});