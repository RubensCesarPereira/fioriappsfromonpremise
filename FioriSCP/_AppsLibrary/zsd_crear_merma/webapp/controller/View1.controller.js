sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,a){"use strict";var r=null;var i="";return e.extend("conchaytoro.cl.zsd_crear_merma.controller.View1",{onInit:function(){r=this;var e=new t;this.getView().setModel(e,"aux");var a={merma:[{name:"Y03",value:"Merma por Relleno"},{name:"Y05",value:"Merma por Accidente"}]};var i=new t(a);this.getView().setModel(i,"mm");var s={motivo:[{name:"1",value:"Por Proceso"},{name:"2",value:"Extraordinaria"},{name:"3",value:"Por Ineficiencia"}]};var o=new t(s);this.getView().setModel(o,"pp")},_position:function(){var e=0;var t=this.getView().byId("posTable");e=t.getItems().length;e=(e+1)*10;return e},_descript:function(e){var t=e.getSource().getParent().getCells()[1].getValue();var a=e.getSource().getParent().getCells()[5];a.removeAllItems();var s=r.getView().byId("centro").getSelectedKey();var o=e.getSource().getParent().getCells()[2];var l=e.getSource().getParent().getCells()[4];var n="Sin Descripción";var u=this.getOwnerComponent().getModel();u.read("/MaterialSet(Matnr='"+t+"',Werks='"+s+"')",{success:function(e){if(e.Matnr===""){sap.m.MessageBox.warning("¡Material No Existe en Bodega seleccionada!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{n=e.Maktx;i=e.Meins;o.setProperty("text",n);l.setProperty("text",i);var r=[];var c=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,t);r.push(c);c=new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,s);r.push(c);u.read("/AlmacenSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Lgort,text:e.Lgobe,additionalText:e.Lgort});a.addItem(t)})}.bind(this),filters:r})}}.bind(this),error:function(e){var t="hola";return t}})},onAdd:function(e){if(!this._validaCamposTabla()){return}var t=r.getView().byId("movimiento");var a=r.getView().byId("centro");var i=r.getView().byId("costo");var s=r.getView().byId("motivo");var o=t.getSelectedKey();var l=a.getSelectedKey();var n=i.getSelectedKey();var u=s.getSelectedKey();var c="/AlmacenSet?$filter=Werks%20eq%20%27"+l+"%27";if(o===""||l===""||n===""||u===""){sap.m.MessageBox.warning("¡Favor Completar todos los Campos de Cabecera!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}sap.ui.core.BusyIndicator.show();var g=this._position();var d=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:g}),new sap.m.Input({maxLength:10,liveChange:function(e){var t=e.getSource().getParent().getCells()[1];var a=e.getSource().getParent().getCells()[5];a.removeAllItems();if(l===""){sap.m.MessageBox.warning("¡Seleccione Bodega!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});t.setValue("")}else{if(/^(M?\d{4}-?\d{4})|\d{6}$/.test(t.getValue())){r.handleValidationSuccess(e)}else{r.handleValidationError(e)}}},placeholder:"Ej: 1112-2006",editable:true}),new sap.m.Text({}),new sap.m.Input({required:true,maxLength:12,type:sap.m.Input.Currency,liveChange:this.validaInput,placeholder:"Ej: 5.000",editable:true}),new sap.m.Text({}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,editable:true,change:function(e){var t=e.getSource().getParent().getCells()[1].getValue();var a=r.getView().byId("centro").getSelectedKey();var i=e.getSource().getParent().getCells()[5].getSelectedKey();var s=e.getSource().getParent().getCells()[6];var o=this.getModel();var l=[];var n=new sap.ui.model.Filter("IMatnr",sap.ui.model.FilterOperator.EQ,t);l.push(n);n=new sap.ui.model.Filter("IWerks",sap.ui.model.FilterOperator.EQ,a);l.push(n);n=new sap.ui.model.Filter("ILgort",sap.ui.model.FilterOperator.EQ,i);l.push(n);o.read("/LoteSet",{success:function(e){e.results.forEach(function(e){var t=new sap.ui.core.ListItem({key:e.Batch,text:e.Clabs+" - "+e.Atwrt,additionalText:e.Batch});s.addItem(t)})}.bind(this),filters:l})}}),new sap.m.ComboBox({required:true,showSecondaryValues:true,filterSecondaryValues:true,editable:true,change:function(e){e.getSource().setValue(e.getSource().getSelectedKey())}}),new sap.m.Button({icon:"sap-icon://decline",width:"3em",press:[this._remove,this]})]});sap.ui.core.BusyIndicator.hide();var p=r.getView().byId("posTable");p.addItem(d)},validaInput:function(e){var t=e.getSource().getParent().getCells()[1].getValue();var a=e.getSource().getParent().getCells()[3];if(t===""){sap.m.MessageBox.warning("¡Ingrese Material!",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});a.setValue("")}else{r.addDot(e)}},addDot:function(e){if(!/^[\d]+(\.[\d]{3,})*(\,[\d]{1,3})?$/.test(e.getParameter("value"))){e.getSource().setValue(e.getParameter("value"));e.getSource().setValueState(sap.ui.core.ValueState.Error);return}e.getSource().setValueState(sap.ui.core.ValueState.Success);var t=e.getParameter("value");var a=t.split(".").join("");a=a.split(",");var r=a[0].split("").reverse();var i=[];var s="";var o=Math.ceil(r.length/3);for(var l=0;l<o;l++){for(var n=0;n<3;n++){if(r[n+l*3]!=undefined){s+=r[n+l*3]}}i.push(s);s="";if(a[1]!==undefined)e.getSource().setValue(i.join(".").split("").reverse().join("")+","+a[1]);else e.getSource().setValue(i.join(".").split("").reverse().join(""))}},clearInput:function(e){var t=this.getView().byId("movimiento");var a=this.getView().byId("centro");var r=this.getView().byId("costo");var i=this.getView().byId("motivo");t.setValue("");a.setValue("");r.setValue("");i.setValue("")},clearCells:function(e){var t=this.getView().byId("posTable");t.removeAllItems()},_clearMatnr:function(){this.getView().byId("costo").setValue("");this.getView().byId("motivo").setValue("");this.clearCells()},onSave:function(e){if(!this._validaCamposTabla()){return}var t=this;var a=this.getView().byId("movimiento");var r=this.getView().byId("centro");var i=this.getView().byId("costo");var s=this.getView().byId("motivo");var o=this.getView().byId("posTable");var l=a.getSelectedKey();var n=r.getSelectedKey();var u=i.getSelectedKey();var c=s.getSelectedKey();var g=o.getItems();var d=[];g.forEach(function(e){d.push({Rsnum:"",Rspos:e.getCells()[0].getText(),Material:e.getCells()[1].getValue(),StoreLoc:e.getCells()[5].getSelectedKey(),Batch:e.getCells()[6].getSelectedKey(),Quantity:e.getCells()[3].getValue(),Unit:e.getCells()[4].getText()})});var p=this.getOwnerComponent().getModel("dos");var v={Rsnum:"",MoveType:l,Plant:n,Kostl:u,Motivo:c,MermaToPosiciones:d};sap.ui.core.BusyIndicator.show();p.create("/HeaderMermaSet",v,{success:function(e){sap.ui.core.BusyIndicator.hide();if(e.Rsnum==="0000000000"){sap.m.MessageBox.warning("¡El pedido no se ha creado! Verifique Datos Ingresados.",{title:"Advertencia",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}else{sap.m.MessageBox.success("¡Merma N° "+e.Rsnum+" ha sido Creada!",{title:"Confirmación",onClose:function(){t.clearInput();t.clearCells()},styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("¡Error al Crear Merma!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})},_onSave:function(e){var t=[];t.push({Rsnum:"",Rspos:"",Material:"1104-2019",StoreLoc:"0005",Batch:"0000411957",Quantity:"1.320",Unit:"L"});var a=this.getOwnerComponent().getModel("dos");var r={Rsnum:"",MoveType:"Y03",Plant:"1021",Kostl:"1020207",Motivo:"ZT",MermaToPosiciones:t};sap.ui.core.BusyIndicator.show();a.create("/HeaderMermaSet",r,{success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.success("¡Merma N° "+e.Rsnum+" ha sido Creada!",{title:"Confirmación",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this),error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Error al Crear Solicitud",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}.bind(this)})},onUpdateFinished:function(e){var t="Posiciones",a=this.getView().byId("posTable");if(a.getBinding("items").isLengthFinal()){var r=e.getParameter("total"),i=a.getItems().length;t+="("+r+")"}this.getView().byId("title").setText(t)},handleValidationError:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);var t=e.getSource().getParent().getCells()[2];var a=e.getSource().getParent().getCells()[4];t.setProperty("text","");a.setProperty("text","")},handleValidationSuccess:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);r._descript(e)},handleValidationError2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Error);this.validaInput()},handleValidationSuccess2:function(e){e.getSource().setValueState(sap.ui.core.ValueState.Success);this.validaInput()},_remove:function(e){var t=r.getView().byId("posTable");t.removeItem(e.getSource().getParent())},_validaCamposTabla:function(){var e=r.getView().byId("posTable");if(e.getItems().length===0)return true;var t=true;e.getItems().forEach(function(e){if(e.getCells()[0].getText()===""||e.getCells()[1].getValue()===""||e.getCells()[1].getValueState()!==sap.ui.core.ValueState.Success||e.getCells()[2].getText()===""||e.getCells()[3].getValue()===""||e.getCells()[3].getValueState()!==sap.ui.core.ValueState.Success||e.getCells()[4].getText()===""||e.getCells()[5].getValue()===""||e.getCells()[6].getValue()===""){t=false;return}t=/^\d{2}.\d{2}.\d{4}$/.test(e.getCells()[6].getValue())});if(!t)sap.m.MessageBox.error("¡No es posible Crear, campos Vacíos o con datos Erróneos!",{title:"Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return t},handleDate:function(e){var t=e.getSource();var a=e.getParameter("valid");if(a){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error)}}})});